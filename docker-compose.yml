version: '3.8'

services:
  # Web 服务
  web:
    build: .
    container_name: apns_web
    volumes:
      - ./:/app
      - ./db.sqlite3:/app/db.sqlite3  # 直接映射本地数据库文件
      - ./staticfiles:/app/staticfiles  # 项目静态文件
      - ./media:/app/media  # 媒体文件
      - /var/www/apns/static:/app/staticfiles
      - /var/www/apns/static:/app/media
    ports:
      - "8003:8003"
    environment:
      - DEBUG=False
      - ALLOWED_HOSTS=localhost,127.0.0.1,users.pulseheath.com
      - STATIC_URL=/apns/static/
      - MEDIA_URL=/apns/media/
      - BASE_URL=https://users.pulseheath.com/
      - CELERY_BROKER_URL=redis://redis_celery:6380/0
      - CELERY_RESULT_BACKEND=redis://redis_celery:6380/0
    restart: always
    command: ["python", "manage.py", "runserver", "0.0.0.0:8003"]
    depends_on:
      - redis_celery

  # Celery Worker
  celery_worker:
    image: apns_web  # 使用与web服务相同的镜像
    container_name: apns_celery_worker
    volumes:
      - ./:/app  # 与web服务保持一致的卷映射
      - ./db.sqlite3:/app/db.sqlite3
      - ./staticfiles:/app/staticfiles
      - ./media:/app/media
    environment:
      - DEBUG=False
      - ALLOWED_HOSTS=localhost,127.0.0.1,users.pulseheath.com
      - STATIC_URL=/apns/static/
      - MEDIA_URL=/apns/media/
      - BASE_URL=https://users.pulseheath.com/
      - CELERY_BROKER_URL=redis://redis_celery:6380/0
      - CELERY_RESULT_BACKEND=redis://redis_celery:6380/0
    restart: always
    command: celery -A apns worker --loglevel=info
    depends_on:
      - redis_celery
      - web  # 确保web服务先启动，因为我们使用web服务的镜像

  # Celery Beat
  celery_beat:
    image: apns_web  # 使用与web服务相同的镜像
    container_name: apns_celery_beat
    volumes:
      - ./:/app  # 与web服务保持一致的卷映射
      - ./db.sqlite3:/app/db.sqlite3
      - ./staticfiles:/app/staticfiles
      - ./media:/app/media
    environment:
      - DEBUG=False
      - ALLOWED_HOSTS=localhost,127.0.0.1,users.pulseheath.com
      - STATIC_URL=/apns/static/
      - MEDIA_URL=/apns/media/
      - BASE_URL=http://localhost:8000
      - CELERY_BROKER_URL=redis://redis_celery:6380/0
      - CELERY_RESULT_BACKEND=redis://redis_celery:6380/0
    restart: always
    command: celery -A apns beat --loglevel=info
    depends_on:
      - redis_celery
      - web  # 确保web服务先启动，因为我们使用web服务的镜像

  # Redis for Celery
  redis_celery:
    image: redis:7-alpine
    container_name: apns_redis_celery
    command: redis-server --port 6380
    ports:
      - "6380:6380"  # 使用不同的端口
    volumes:
      - redis_celery_data:/data
    restart: always

volumes:
  redis_celery_data: 